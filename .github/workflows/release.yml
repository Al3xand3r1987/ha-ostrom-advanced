name: Release

on:
  release:
    types: [published]  # Triggert nur bei manuell erstellten Releases auf GitHub

permissions:
  contents: write  # Erforderlich f√ºr das Aktualisieren von Releases

jobs:
  update-release-notes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Vollst√§ndige Git-Historie f√ºr Release Notes

      - name: Get previous tag
        id: previous_tag
        run: |
          CURRENT_TAG="${{ github.event.release.tag_name }}"
          echo "Current release tag: $CURRENT_TAG"
          
          # Versuche vorherigen Tag zu finden
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # Fallback: Suche nach dem letzten Tag vor dem aktuellen
            PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -v "^${CURRENT_TAG}$" | head -n 1 || echo "")
          fi
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # Letzter Fallback: Erster Commit
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
            echo "‚ö†Ô∏è No previous tag found, using first commit: $PREVIOUS_TAG"
          else
            echo "‚úÖ Found previous tag: $PREVIOUS_TAG"
          fi
          
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "Generating release notes from $PREVIOUS_TAG to $CURRENT_TAG"

      - name: Generate release notes from commits
        id: release_notes
        run: |
          CURRENT_TAG="${{ github.event.release.tag_name }}"
          PREVIOUS_TAG="${{ steps.previous_tag.outputs.previous_tag }}"
          
          echo "üìù Generating release notes from $PREVIOUS_TAG to $CURRENT_TAG"
          
          # Pr√ºfe ob es Commits gibt
          COMMIT_COUNT=$(git rev-list --count ${PREVIOUS_TAG}..${CURRENT_TAG} 2>/dev/null || echo "0")
          echo "Found $COMMIT_COUNT commits"
          
          if [ "$COMMIT_COUNT" -eq "0" ]; then
            echo "‚ö†Ô∏è No commits found between tags, creating empty release notes"
            echo 'notes<<EOF' > $GITHUB_OUTPUT
            echo "## üì¶ Release $CURRENT_TAG" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "No commits found between $PREVIOUS_TAG and $CURRENT_TAG" >> $GITHUB_OUTPUT
            echo EOF >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Kategorisiere Commits nach Conventional Commits
          # Priorit√§t: Features ‚Üí Fixes ‚Üí Maintenance ‚Üí Docs
          FEATURES=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges | grep -E "^-\s*(feat|feature):" | sed 's/^-\s*\(feat\|feature\):/-/' || echo "")
          FIXES=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges | grep -E "^-\s*(fix|bug):" | sed 's/^-\s*\(fix\|bug\):/-/' || echo "")
          CHORES=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges | grep -E "^-\s*(chore|refactor):" | sed 's/^-\s*\(chore\|refactor\):/-/' || echo "")
          DOCS=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges | grep -E "^-\s*docs:" | sed 's/^-\s*docs:/-/' || echo "")
          OTHER=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges | grep -vE "^-\s*(feat|feature|fix|bug|docs|chore|refactor):" || echo "")
          
          echo "üìä Categorized commits:"
          echo "  Features: $(echo "$FEATURES" | grep -c "^" || echo "0")"
          echo "  Fixes: $(echo "$FIXES" | grep -c "^" || echo "0")"
          echo "  Chores: $(echo "$CHORES" | grep -c "^" || echo "0")"
          echo "  Docs: $(echo "$DOCS" | grep -c "^" || echo "0")"
          echo "  Other: $(echo "$OTHER" | grep -c "^" || echo "0")"
          
          # Baue Release Notes zusammen (Priorit√§t: Features ‚Üí Fixes ‚Üí Maintenance ‚Üí Docs)
          {
            echo 'notes<<EOF'
            if [ -n "$FEATURES" ]; then
              echo "## üöÄ New Features"
              echo "$FEATURES"
              echo ""
            fi
            if [ -n "$FIXES" ]; then
              echo "## üêõ Bug Fixes"
              echo "$FIXES"
              echo ""
            fi
            if [ -n "$CHORES" ]; then
              echo "## üîß Maintenance"
              echo "$CHORES"
              echo ""
            fi
            if [ -n "$DOCS" ]; then
              echo "## üìù Documentation"
              echo "$DOCS"
              echo ""
            fi
            if [ -n "$OTHER" ]; then
              echo "## üì¶ Other Changes"
              echo "$OTHER"
            fi
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Get existing release body
        id: existing_body
        run: |
          EXISTING_BODY="${{ github.event.release.body }}"
          if [ -n "$EXISTING_BODY" ] && [ "$EXISTING_BODY" != "null" ]; then
            echo "has_existing_body=true" >> $GITHUB_OUTPUT
            echo "Existing release notes found, keeping them"
          else
            echo "has_existing_body=false" >> $GITHUB_OUTPUT
            echo "No existing release notes, will use generated ones"
          fi

      - name: Update Release (only if no existing notes)
        if: steps.existing_body.outputs.has_existing_body == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name }}
          name: Ostrom Advanced ${{ github.event.release.tag_name }}
          body: |
            ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Notes already exist
        if: steps.existing_body.outputs.has_existing_body == 'true'
        run: |
          echo "Release notes were manually added, keeping them unchanged"
          echo "Generated notes are available in the workflow logs for reference"
