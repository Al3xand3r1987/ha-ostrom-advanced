name: Release

on:
  release:
    types: [published]  # Triggert nur bei manuell erstellten Releases auf GitHub

permissions:
  contents: write  # Erforderlich fÃ¼r das Aktualisieren von Releases

jobs:
  update-release-notes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # VollstÃ¤ndige Git-Historie fÃ¼r Release Notes

      - name: Get previous tag
        id: previous_tag
        run: |
          CURRENT_TAG="${{ github.event.release.tag_name }}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            # Fallback: Erster Commit, wenn kein vorheriger Tag existiert
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREVIOUS_TAG"
          echo "Current tag: $CURRENT_TAG"

      - name: Generate release notes from commits
        id: release_notes
        run: |
          CURRENT_TAG="${{ github.event.release.tag_name }}"
          PREVIOUS_TAG="${{ steps.previous_tag.outputs.previous_tag }}"
          
          echo "Generating release notes from $PREVIOUS_TAG to $CURRENT_TAG"
          
          # Kategorisiere Commits nach Conventional Commits
          # PrioritÃ¤t: Features â†’ Fixes â†’ Maintenance â†’ Docs
          FEATURES=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges | grep -E "^-\s*(feat|feature):" | sed 's/^-\s*\(feat\|feature\):/-/' || echo "")
          FIXES=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges | grep -E "^-\s*(fix|bug):" | sed 's/^-\s*\(fix\|bug\):/-/' || echo "")
          CHORES=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges | grep -E "^-\s*(chore|refactor):" | sed 's/^-\s*\(chore\|refactor\):/-/' || echo "")
          DOCS=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges | grep -E "^-\s*docs:" | sed 's/^-\s*docs:/-/' || echo "")
          OTHER=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges | grep -vE "^-\s*(feat|feature|fix|bug|docs|chore|refactor):" || echo "")
          
          # Baue Release Notes zusammen (PrioritÃ¤t: Features â†’ Fixes â†’ Maintenance â†’ Docs)
          {
            echo 'notes<<EOF'
            if [ -n "$FEATURES" ]; then
              echo "## ðŸš€ New Features"
              echo "$FEATURES"
              echo ""
            fi
            if [ -n "$FIXES" ]; then
              echo "## ðŸ› Bug Fixes"
              echo "$FIXES"
              echo ""
            fi
            if [ -n "$CHORES" ]; then
              echo "## ðŸ”§ Maintenance"
              echo "$CHORES"
              echo ""
            fi
            if [ -n "$DOCS" ]; then
              echo "## ðŸ“ Documentation"
              echo "$DOCS"
              echo ""
            fi
            if [ -n "$OTHER" ]; then
              echo "## ðŸ“¦ Other Changes"
              echo "$OTHER"
            fi
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Get existing release body
        id: existing_body
        run: |
          EXISTING_BODY="${{ github.event.release.body }}"
          if [ -n "$EXISTING_BODY" ] && [ "$EXISTING_BODY" != "null" ]; then
            echo "has_existing_body=true" >> $GITHUB_OUTPUT
            echo "Existing release notes found, keeping them"
          else
            echo "has_existing_body=false" >> $GITHUB_OUTPUT
            echo "No existing release notes, will use generated ones"
          fi

      - name: Update Release (only if no existing notes)
        if: steps.existing_body.outputs.has_existing_body == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name }}
          name: Ostrom Advanced ${{ github.event.release.tag_name }}
          body: |
            ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Notes already exist
        if: steps.existing_body.outputs.has_existing_body == 'true'
        run: |
          echo "Release notes were manually added, keeping them unchanged"
          echo "Generated notes are available in the workflow logs for reference"
